# Тестирование на эскалацию привилегий

| ID |
| ------------- |
| WSTG-ATHZ-03 |

## Резюме

В этом разделе описывается проблема увеличения привилегий с одного этапа на другой. На этом этапе тестер должен убедиться, что пользователь не может изменить свои привилегии или роли внутри приложения таким образом, чтобы это могло позволить атаки на повышение привилегий.

Повышение привилегий происходит, когда пользователь получает доступ к большему количеству ресурсов или функций, чем обычно разрешено, и такое повышение или изменения должны были быть предотвращены приложением. Обычно это вызвано недостатком приложения. В результате приложение выполняет действия с большим количеством привилегий, чем те, которые предназначены разработчиком или системным администратором.

Степень эскалации зависит от того, какими привилегиями злоумышленник уполномочен обладать, и какие привилегии можно получить в успешном эксплойте. Например, ошибка программирования, которая позволяет пользователю получить дополнительные привилегии после успешной аутентификации, ограничивает степень эскалации, поскольку пользователь уже уполномочен иметь некоторые привилегии. Аналогично, удаленный злоумышленник, получающий привилегию суперпользователя без какой-либо аутентификации, представляет большую степень эскалации.

Обычно люди ссылаются на * вертикальную эскалацию *, когда можно получить доступ к ресурсам, предоставляемым для более привилегированных учетных записей (например,., получение административных привилегий для приложения) и к * горизонтальное повышение *, когда можно получить доступ к ресурсам, предоставленным аналогично настроенной учетной записи (например,.в онлайн-приложении, доступ к информации, связанной с другим пользователем).

## Цели теста

- Определите точки инъекции, связанные с манипулированием привилегиями.
- FUZZ или иным образом попытка обойти меры безопасности.

## Как проверить

### Тестирование на манипуляцию ролями / привилегиями

В каждой части приложения, где пользователь может создавать информацию в базе данных (например,., сделав платеж, добавив контакт или отправив сообщение), можно получить информацию (учетная запись, данные заказа и т. д.).) или удалить информацию (передать пользователей, сообщения и т. д.), необходимо записать эту функциональность. Тестер должен попытаться получить доступ к таким функциям, как другой пользователь, чтобы проверить, возможно ли получить доступ к функции, которая не должна быть разрешена ролью / привилегией пользователя (но может быть разрешена как другой пользователь).

#### Манипулирование группой пользователей

Например:
Следующий HTTP POST позволяет пользователю, который принадлежит `grp001`, получить доступ к порядку # 0001 :

```http
POST /user/viewOrder.jsp HTTP/1.1
Host: www.example.com
...

groupID=grp001&orderID=0001
```

Убедитесь, что пользователь, не принадлежащий `grp001`, может изменить значение параметров `groupID` и `orderID`, чтобы получить доступ к этим привилегированным данным.

#### Манипулирование профилем пользователя

Например:
Ответ следующего сервера показывает скрытое поле в HTML, возвращаемое пользователю после успешной аутентификации.

```html
HTTP/1.1 200 OK
Server: Netscape-Enterprise/6.0
Date: Wed, 1 Apr 2006 13:51:20 GMT
Set-Cookie: USER=aW78ryrGrTWs4MnOd32Fs51yDqp; path=/; domain=www.example.com
Set-Cookie: SESSION=k+KmKeHXTgDi1J5fT7Zz; path=/; domain= www.example.com
Cache-Control: no-cache
Pragma: No-cache
Content-length: 247
Content-Type: text/html
Expires: Thu, 01 Jan 1970 00:00:00 GMT
Connection: close

<form  name="autoriz" method="POST" action = "visual.jsp">
<input type="hidden" name="profile" value="SysAdmin">\

<body onload="document.forms.autoriz.submit()">
</td>
</tr>
```

Что делать, если тестер изменяет значение переменной `profile` на `SysAdmin`? Можно ли стать **administrator**?

#### Манипулирование значением состояния

Например:
В среде, где сервер отправляет сообщение об ошибке, содержащееся в виде значения в определенном параметре в наборе кодов ответов, следующим образом:

```text
@0`1`3`3``0`UC`1`Status`OK`SEC`5`1`0`ResultSet`0`PVValid`-1`0`0` Notifications`0`0`3`Command  Manager`0`0`0` StateToolsBar`0`0`0`
StateExecToolBar`0`0`0`FlagsToolBar`0
```

Сервер дает неявное доверие пользователю. Он считает, что пользователь ответит вышеуказанным сообщением, закрывающим сеанс.

В этом условии убедитесь, что невозможно увеличить привилегии путем изменения значений параметров. В этом конкретном примере, изменив значение `PVValid` с `-1` на `0` (без условий ошибки), можно выполнить аутентификацию в качестве администратора на сервере.

#### Манипулирование IP-адресом

Некоторые сайты ограничивают доступ или подсчитывают количество неудачных попыток входа в систему на основе IP-адреса.

Например:

```text
X-Forwarded-For: 8.1.1.1
```

В этом случае, если сайт использует значение `X-forwarded-For` в качестве IP-адреса клиента тестер может изменить значение IP `X-forwarded-For` Заголовок HTTP для обходной идентификации источника IP.

### Тестирование для схемы разрешения вертикального обхода

Обойдя вертикальной авторизации специфичен для случая, когда злоумышленник получает роль выше своей. Тестирование для этого обхода фокусируется на проверке того, как схема вертикальной авторизации была реализована для каждой роли. Для каждой функции, страницы, конкретной роли или запроса, который выполняет приложение, необходимо проверить, возможно ли:

- Доступ к ресурсам, которые должны быть доступны только для более высокого роли пользователя.
- Работать с функциями на ресурсах, которые должны работать только пользователем, который имеет более высокую или конкретную роль.

Для каждой роли:

1. Зарегистрируйте пользователя.
2. Установите и поддерживайте две разные сессии на основе двух разных ролей.
3. Для каждого запроса измените идентификатор сеанса с оригинала на идентификатор сеанса другой роли и оцените ответы для каждого.
4. Приложение будет считаться уязвимым, если более слабый привилегированный сеанс содержит те же данные, или указывает на успешные операции с более высокими привилегированными функциями.

#### Сценарий роли банковского сайта

Следующая таблица иллюстрирует роли системы на банковском сайте. Каждая роль связана с определенными разрешениями для функциональности меню события :

|      ROLE     |     PERMISSION    | ADDITIONAL PERMISSION |
|---------------|-------------------|-----------------------|
| Administrator | Full Control      | Delete                |
| Manager       | Modify, Add, Read | Add                   |
| Staff         | Read, Modify      | Modify                |
| Customer      | Read Only         |                       |

Приложение будет считаться уязвимым, если:

1. Клиент может управлять функциями администратора, менеджера или персонала;
2. Пользователь персонала может управлять функциями менеджера или администратора;
3. Менеджер может управлять функциями администратора.

Предположим, что функция `deleteEvent` является частью меню учетной записи администратора приложения, и к ней можно получить доступ, запросив следующий URL: `https://www.example.com/account/deleteEvent`. Затем при вызове функции `deleteEvent` генерируется следующий HTTP-запрос:

```http
POST /account/deleteEvent HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=ADMINISTRATOR_USER_SESSION

EventID=1000001
```

Действительный ответ:

```http
HTTP/1.1 200 OK
[other HTTP headers]

{"message": "Event was deleted"}
```

Злоумышленник может попытаться выполнить тот же запрос:

```http
POST /account/deleteEvent HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=CUSTOMER_USER_SESSION

EventID=1000002
```

Если ответ запроса злоумышленника содержит те же данные `{"message": "Event was deleted"}` приложение уязвимо.

#### Доступ к странице администратора

Предположим, что меню администратора является частью учетной записи администратора.

Приложение будет считаться уязвимым, если какая-либо роль, кроме администратора, может получить доступ к меню администратора. Иногда разработчики выполняют проверку авторизации только на уровне графического интерфейса и оставляют функции без проверки авторизации, что может привести к уязвимости.

### URL Traversal

Попробуйте просмотреть веб-сайт и проверить, не пропустили ли некоторые страницы, которые могут пропустить проверку авторизации.

Например:

```text
/../.././userInfo.html
```

### WhiteBox

Если проверка авторизации URL выполняется только путем частичного сопоставления URL, то, вероятно, тестеры или хакеры могут обойти авторизацию с помощью методов кодирования URL.

Например:

```text
startswith(), endswith(), contains(), indexOf()
```

### Слабый SessionID

Слабый идентификатор сеанса имеет алгоритм может быть уязвим для грубой атаки Силы. Например, один сайт использует `MD5(Password + UserID)` как sessionID. Затем тестеры могут угадать или сгенерировать sessionID для других пользователей.

## References

### Whitepapers

- [Wikipedia - Privilege Escalation](https://en.wikipedia.org/wiki/Privilege_escalation)

## Tools

- [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org)
