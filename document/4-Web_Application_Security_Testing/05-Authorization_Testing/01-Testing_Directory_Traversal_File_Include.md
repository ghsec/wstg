# Тестирование каталога Traversal File Include

| ID |
| ------------- |
| WSTG-ATHZ-01 |

## Резюме

Многие веб-приложения используют и управляют файлами как часть своей повседневной работы. Используя методы проверки ввода, которые не были хорошо разработаны или развернуты, агрессор может использовать систему для чтения или записи файлов, которые не предназначены для доступности. В определенных ситуациях может быть возможно выполнить произвольный код или системные команды.

Традиционно веб-серверы и веб-приложения реализуют механизмы аутентификации для контроля доступа к файлам и ресурсам. Веб-серверы пытаются ограничить файлы пользователей в «корневом каталоге» или «корневом веб-документе», который представляет физический каталог в файловой системе. Пользователи должны рассматривать этот каталог как базовый каталог в иерархической структуре веб-приложения.

Определение привилегий производится с использованием списков контроля доступа (ACL), которые определяют, какие пользователи или группы должны иметь доступ, изменять или выполнять определенный файл на сервере. Эти механизмы предназначены для предотвращения доступа вредоносных пользователей к конфиденциальным файлам (например, общим `/etc/passwd` файл на UNIX-подобной платформе) или во избежание выполнения системных команд.

Многие веб-приложения используют серверные сценарии для включения различных типов файлов. Этот метод довольно часто используется для управления изображениями, шаблонами, загрузкой статических текстов и так далее. К сожалению, эти приложения обнаруживают уязвимости безопасности при вводе параметров (т.е.параметры формы, значения cookie) не проверены правильно.

На веб-серверах и веб-приложениях такая проблема возникает при переходах пути / включении файлов. Используя этот вид уязвимости, злоумышленник может читать каталоги или файлы, которые он обычно не может прочитать, получать доступ к данным за пределами корня веб-документа или включать сценарии и другие виды файлов с внешних веб-сайтов.

Для целей Руководства по тестированию OWASP будут рассматриваться только угрозы безопасности, связанные с веб-приложениями, а не угрозы веб-серверам (например,.печально известный код выхода "% 5c" на веб-сервере Microsoft IIS). Дополнительные предложения по чтению будут представлены в разделе ссылок для заинтересованных читателей.

Этот вид атаки также известен как атака точка-точка-косая черта (`../ `), пересечение каталогов, скалолазание или обратный путь.

Во время оценки, чтобы обнаружить путь прохождения и файл, включите недостатки, тестировщики должны выполнить два разных этапа:

1. Перечень векторов ввода (систематическая оценка каждого входного вектора)
2. Методы тестирования (методическая оценка каждой техники атаки, используемой злоумышленником для использования уязвимости)

## Цели теста

- Определите точки инъекции, которые относятся к пересечению пути.
- Оцените методы обхода и определите степень прохождения пути.

## Как проверить

### Тестирование черного ящика

#### Input Vectors Enumeration

Чтобы определить, какая часть приложения уязвима для обхода проверки ввода, тестер должен перечислить все части приложения, которые принимают контент от пользователя. Это также включает в себя HTTP GET и POST запросы и общие параметры, такие как загрузка файлов и HTML-формы.

Вот несколько примеров проверок, которые будут выполнены на данном этапе:

- Существуют ли параметры запроса, которые можно использовать для операций, связанных с файлами?
- Есть ли необычные расширения файлов?
- Есть ли интересные имена переменных?
    - `http://example.com/getUserProfile.jsp?item=ikki.html`
    - `http://example.com/index.php?file=content`
    - `http://example.com/main.cgi?home=index.htm`
- Можно ли идентифицировать файлы cookie, используемые веб-приложением для динамического создания страниц или шаблонов?
    - `Cookie: ID=d9ccd3f4f9f18cc1:TM=2166255468:LM=1162655568:S=3cFpqbJgMSSPKVMV:TEMPLATE=flower`
    - `Cookie: USER=1826cc8f:PSTYLE=GreenDotRed`

#### Методы тестирования

Следующим этапом тестирования является анализ функций проверки входных данных, присутствующих в веб-приложении. Используя предыдущий пример, динамическая страница с именем `getUserProfile.jsp` загружает статическую информацию из файла и показывает содержимое пользователям. Злоумышленник может вставить вредоносную строку `../../../../etc/passwd` включить хэш-файл пароля системы Linux / UNIX. Очевидно, что такого рода атака возможна только в случае сбоя контрольной точки проверки; в соответствии с привилегиями файловой системы само веб-приложение должно иметь возможность читать файл.

**Note:** Чтобы успешно проверить этот недостаток, тестер должен знать, какая система тестируется и где запрашиваются файлы. Нет смысла запрашивать `/etc/passwd` с веб-сервера IIS.

```text
http://example.com/getUserProfile.jsp?item=../../../../etc/passwd
```

Другой распространенный пример - включение контента из внешнего источника:

```text
http://example.com/index.php?file=http://www.owasp.org/malicioustxt
```

То же самое можно применить к файлам cookie или любому другому входному вектору, который используется для динамического создания страниц.

Больше полезных нагрузок включения файла можно найти по адресу [PayloadsAllTheThings - File Inclusion](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion)

Важно отметить, что разные операционные системы используют разные разделители путей

- Unix-подобная ОС :
    - корневой каталог: `/`
    - directory separator: `/`
- Windows OS:
    - root directory: `<drive letter>:`
    - directory separator: `\` or `/`
- Classic macOS:
    - root directory: `<drive letter>:`
    - directory separator: `:`

Разработчики часто не ожидают, что все формы кодирования будут выполняться, и поэтому проводят проверку только для основного закодированного контента. Если сначала тестовая строка не удалась, попробуйте другую схему кодирования.

Вы можете найти методы кодирования и готовые к использованию полезные нагрузки для обхода каталогов [PayloadsAllTheThings - Directory Traversal](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal)

#### Особые соображения Windows

- Оболочка Windows: добавление любого из следующего к путям, используемым в команде оболочки, не приводит к разнице в функции:
    - Угловые скобки `<` и `> `в конце пути
    - Двойные кавычки (закрыты правильно) в конце пути
    - Посторонние маркеры текущего каталога, такие как `./` or `.\\`
    - Посторонние маркеры родительских каталогов с произвольными элементами, которые могут существовать или не существовать:
        - `file.txt`
        - `file.txt...`
        - `file.txt<spaces>`
        - `file.txt""""`
        - `file.txt<<<>>><`
        - `./././file.txt`
        - `nonexistant/../file.txt`
- Windows API: следующие элементы отбрасываются при использовании в любой команде оболочки или вызове API, где строка берется в качестве имени файла:
    - периоды
    - пробелы
- Filepaths Windows UNC: используется для ссылок на файлы на акции SMB. Иногда можно подать заявку на обращение к файлам на удаленном пути к файлу UNC. Если это так, SMB-сервер Windows может отправлять сохраненные учетные данные злоумышленнику, которые могут быть захвачены и взломаны. Они также могут использоваться с самореферентным IP-адресом или доменным именем для уклонения от фильтров или использоваться для доступа к файлам на общих долях SMB, недоступных злоумышленнику, но доступных с веб-сервера.
    - `\\server_or_ip\path\to\file.abc`
    - `\\?\server_or_ip\path\to\file.abc`
- Пространство имен устройств Windows NT: используется для ссылки на пространство имен устройств Windows. Некоторые ссылки позволят получить доступ к файловым системам по другому пути.
    - Может быть эквивалентно букве диска, такой как `c:\`, или даже громкость диска без назначенной буквы : `\\.\GLOBALROOT\Device\HarddiskVolume1\`
    - Относится к первому дисководу на машине : `\\.\CdRom0\`

### Тестирование серой коробки

Когда анализ выполняется с использованием подхода тестирования «серый ящик», тестировщики должны следовать той же методологии, что и при тестировании «черный ящик». Однако, поскольку они могут просматривать исходный код, можно легче и точнее искать входные векторы. Во время проверки исходного кода они могут использовать простые инструменты (такие как *grep* команда) для поиска одного или нескольких распространенных шаблонов в коде приложения: функции / методы включения, операции файловой системы и т. д.

- `PHP: include(), include_once(), require(), require_once(), fopen(), readfile(), ...`
- `JSP/Servlet: java.io.File(), java.io.FileReader(), ...`
- `ASP: include file, include virtual, ...`

Исползоване посковы систем онлайн-кода (например,., [Searchcode] (https://searchcode.com/)), также может быть возможно найти недостатки пути пересечения в программном обеспечении с открытым исходным кодом, опубликованном в Интернете.

Для PHP тестеры могут использовать следующий регулярное выражение:

```text
(include|require)(_once)?\s*['"(]?\s*\$_(GET|POST|COOKIE)
```

Используя метод тестирования «серых ящиков», можно обнаружить уязвимости, которые обычно труднее обнаружить или даже невозможно найти во время стандартной оценки «черных ящиков».

Некоторые веб-приложения генерируют динамические страницы, используя значения и параметры, хранящиеся в базе данных. Может быть возможно вставить специально созданные строки обхода пути, когда приложение добавляет данные в базу данных. Такого рода проблему безопасности трудно обнаружить из-за того, что параметры внутри функций включения кажутся внутренними и **safe** но не в реальности.

Кроме того, просматривая исходный код, можно проанализировать функции, которые должны обрабатывать недопустимый ввод: некоторые разработчики пытаются изменить недопустимый ввод, чтобы сделать его действительным, избегая предупреждений и ошибок. Эти функции обычно подвержены недостаткам безопасности.

Рассмотрим веб-приложение с этими инструкциями:

```php
filename = Request.QueryString("file");
Replace(filename, "/","\");
Replace(filename, "..\","");
```

Тестирование на недостаток достигается с помощью:

```text
file=....//....//boot.ini
file=....\\....\\boot.ini
file= ..\..\boot.ini
```

## Tools

- [DotDotPwn - The Directory Traversal Fuzzer](https://github.com/wireghoul/dotdotpwn)
- [Path Traversal Fuzz Strings (from WFuzz Tool)](https://github.com/xmendez/wfuzz/blob/master/wordlist/Injections/Traversal.txt)
- [OWASP ZAP](https://www.zaproxy.org/)
- [Burp Suite](https://portswigger.net)
- Enconding/Decoding tools
- [String searcher "grep"](https://www.gnu.org/software/grep/)
- [DirBuster](https://wiki.owasp.org/index.php/Category:OWASP_DirBuster_Project)

## References

- [PayloadsAllTheThings - Directory Traversal](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Directory%20Traversal)
- [PayloadsAllTheThings - File Inclusion](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion)

### Whitepapers

- [phpBB Attachment Mod Directory Traversal HTTP POST Injection](https://seclists.org/vulnwatch/2004/q4/33)
- [Windows File Pseudonyms: Pwnage and Poetry](https://www.slideshare.net/BaronZor/windows-file-pseudonyms)
