# Тестирование для обхода схемы авторизации

| ID |
| ------------- |
| WSTG-ATHZ-02 |

## Резюме

Этот тип теста фокусируется на проверке того, как схема авторизации была реализована для каждой роли или привилегии, чтобы получить доступ к зарезервированным функциям и ресурсам.

Для каждой конкретной роли, которую тестировщик выполняет во время оценки, и для каждой функции и запроса, которые приложение выполняет на этапе после аутентификации, необходимо проверить:

- Можно ли получить доступ к этому ресурсу, даже если пользователь не аутентифицирован?
- Можно ли получить доступ к этому ресурсу после выхода из системы??
- Возможно ли получить доступ к функциям и ресурсам, которые должны быть доступны пользователю, который выполняет другую роль или привилегию?

Попробуйте получить доступ к приложению в качестве административного пользователя и отслеживать все административные функции.

- Можно ли получить доступ к административным функциям, если тестер зарегистрирован как пользователь без администратора?
- Можно ли использовать эти административные функции в качестве пользователя с другой ролью и для которого в этом действии должно быть отказано?

## Цели теста

- Оцените, возможен ли горизонтальный или вертикальный доступ.

## Как проверить

- Доступ к ресурсам и проведение операций по горизонтали.
- Доступ к ресурсам и проведение операций по вертикали.

### Тестирование для схемы разрешения горизонтального обхода

Для каждой функции, конкретной роли или запроса, который выполняет приложение, необходимо проверить:

- Возможно ли получить доступ к ресурсам, которые должны быть доступны пользователю, который имеет другую личность с той же ролью или привилегией?
- Можно ли управлять функциями на ресурсах, которые должны быть доступны пользователю, который имеет другую идентичность?

Для каждой роли:

1. Зарегистрируйтесь или создайте двух пользователей с одинаковыми привилегиями.
2. Установите и сохраните два разных сеанса активными (по одному для каждого пользователя).
3. Для каждого запроса измените соответствующие параметры и идентификатор сеанса с токена один на токен два и диагностируйте ответы для каждого токена.
4. Приложение будет считаться уязвимым, если ответы совпадают, содержат те же личные данные или указывают на успешную работу с ресурсом или данными других пользователей.

Например, предположим, что `viewSettings` функция является частью каждого меню учетной записи приложения с одинаковой ролью, и к ней можно получить доступ, запросив следующий URL: `https://www.example.com/account/viewSettings`. Затем при вызове генерируется следующий HTTP-запрос `viewSettings` функция:

```http
POST /account/viewSettings HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=USER_SESSION

username=example_user
```

Действительный и законный ответ:

```html
HTTP1.1 200 OK
[other HTTP headers]

{
  "username": "example_user",
  "email": "example@email.com",
  "address": "Example Address"
}
```

Злоумышленник может попытаться выполнить этот запрос с тем же `username` параметр:

```html
POST /account/viewCCpincode HTTP/1.1
Host: www.example.com
[other HTTP headers]
Cookie: SessionID=ATTACKER_SESSION

username=example_user
```

Если ответ злоумышленника содержит данные `example_user`, то приложение уязвимо для атак бокового движения, когда пользователь может читать или записывать данные другого пользователя.

### Тестирование на доступ к административным функциям

Например, предположим, что функция `addUser` является частью административного меню приложения, и к ней можно получить доступ, запросив следующий URL `https://www.example.com/admin/addUser`.

Затем при вызове функции `addUser` генерируется следующий HTTP-запрос:

```http
POST /admin/addUser HTTP/1.1
Host: www.example.com
[...]

userID=fakeuser&role=3&group=grp001
```

Дальнейшие вопросы или соображения будут идти в следующем направлении:

- Что произойдет, если неадминистративный пользователь попытается выполнить этот запрос?
- Будет ли пользователь создан?
- Если это так, может ли новый пользователь использовать свои привилегии?

### Тестирование на доступ к ресурсам, назначенным на другую роль

Различные приложения настраивают управление ресурсами на основе ролей пользователей. Давайте возьмем пример резюме или резюме (биографические данные), загруженные в форму карьеры в ведро S3.

Как обычный пользователь, попробуйте получить доступ к расположению этих файлов. Если вы можете получить их, изменить или удалить, приложение уязвимо.

### Тестирование для обработки заголовка специального запроса

Некоторые приложения поддерживают нестандартные заголовки, такие как `X-Original-URL` или `X-Rewrite-URL` чтобы разрешить переопределение целевого URL в запросах с указанным в значении заголовка.

Такое поведение может быть использовано в ситуации, когда приложение находится за компонентом, который применяет ограничение контроля доступа на основе URL-адреса запроса

Тип ограничения контроля доступа, основанный на URL-адресе запроса, может, например, блокировать доступ из Интернета к открытой консоли администрирования `/console` или `/admin`.

Чтобы обнаружить поддержку заголовка `X-Original-URL` или `X-Rewrite-URL`, следующие шаги могут быть применены.

#### 1. Отправить обычный запрос без каких-либо X-Original-Url или X-Rewrite-Url Заголовок

```http
GET / HTTP/1.1
Host: www.example.com
[...]
```

#### 2. Отправить запрос с X-Original-Url Заголовок, указывающий на несуществующий ресурс

```html
GET / HTTP/1.1
Host: www.example.com
X-Original-URL: /donotexist1
[...]
```

#### 3. Отправить запрос с X-Rewrite-Url Заголовок, указывающий на несуществующий ресурс

```html
GET / HTTP/1.1
Host: www.example.com
X-Rewrite-URL: /donotexist2
[...]
```

Если ответ на любой запрос содержит маркеры, которые ресурс не был найден, это указывает на то, что приложение поддерживает специальные заголовки запросов. Эти маркеры могут включать код состояния ответа HTTP 404 или a "resource not found" сообщение в теле ответа.

Однажды поддержка заголовка `X-Original-URL` или `X-Rewrite-URL` был подтвержден, тогда предварительный обход против ограничения контроля доступа можно использовать, отправив ожидаемый запрос в приложение, но указав URL-адрес, «разрешенный» внешним компонентом в качестве основного URL-адреса запроса, и указав реальный целевой URL-адрес в `X-Original-URL` или `X-Rewrite-URL` заголовок в зависимости от поддерживаемого. Если оба поддерживаются, попробуйте один за другим, чтобы проверить, для какого заголовка обход эффективен.

#### 4. Другие заголовки, чтобы рассмотреть

Часто административные панели или связанные с ними функции доступны только для клиентов в локальных сетях, поэтому может быть возможно злоупотреблять различными прокси-серверами или пересылками, связанными с HTTP-заголовками, для получения доступа. Некоторые заголовки и значения для тестирования:

- Headers:
    - `X-Forwarded-For`
    - `X-Forward-For`
    - `X-Remote-IP`
    - `X-Originating-IP`
    - `X-Remote-Addr`
    - `X-Client-IP`
- Values
    - `127.0.0.1` (or anything in the `127.0.0.0/8` or `::1/128` address spaces)
    - `localhost`
    - Any [RFC1918](https://tools.ietf.org/html/rfc1918) address:
        - `10.0.0.0/8`
        - `172.16.0.0/12`
        - `192.168.0.0/16`
    - Link local addresses: `169.254.0.0/16`

Примечание. Включение элемента порта вместе с адресом или именем хоста также может помочь обойти защиту краев, такую как брандмауэры веб-приложений и т. Д.
Например: `127.0.0.4:80`, `127.0.0.4:443`, `127.0.0.4:43982`

## Восстановление

Используйте наименьшие принципы привилегий для пользователей, ролей и ресурсов, чтобы гарантировать отсутствие несанкционированного доступа.

## Tools

- [OWASP Zed Attack Proxy (ZAP)](https://www.zaproxy.org/)
    - [ZAP add-on: Access Control Testing](https://www.zaproxy.org/docs/desktop/addons/access-control-testing/)
- [Port Swigger Burp Suite](https://portswigger.net/burp)
    - [Burp extension: AuthMatrix](https://github.com/SecurityInnovation/AuthMatrix/)
    - [Burp extension: Autorize](https://github.com/Quitten/Autorize)

## References

[OWASP Application Security Verification Standard 4.0.1](https://github.com/OWASP/ASVS/tree/master/4.0), v4.0.1-1, v4.0.1-4, v4.0.1-9, v4.0.1-16
