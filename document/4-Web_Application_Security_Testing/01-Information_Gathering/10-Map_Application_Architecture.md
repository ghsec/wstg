# Карта архитектуры приложений

|ID          |
|------------|
|WSTG-INFO-10|

## Резюме

Чтобы эффективно протестировать приложение и дать содержательные рекомендации о том, как решить любую из выявленных проблем, важно понимать, что вы на самом деле тестируете. Кроме того, это может помочь определить, следует ли считать конкретные компоненты не в рамках тестирования.

Современные веб-приложения могут значительно различаться по сложности: от простого скрипта, работающего на одном сервере, до очень сложного приложения, распространяющегося на десятки различных систем, языков и компонентов. Также могут быть дополнительные компоненты на уровне сети, такие как брандмауэры или системы защиты от вторжений, которые могут оказать существенное влияние на тестирование.

## Цели теста

- Понять архитектуру приложения и используемые технологии.

## Как проверить

При тестировании с точки зрения черного ящика важно попытаться составить четкое представление о том, как работает приложение, и какие технологии и компоненты существуют. В некоторых случаях можно проверить конкретные компоненты (такие как брандмауэр веб-приложения), в то время как другие могут быть идентифицированы путем проверки поведения приложения.

В разделах ниже представлен обзор общих архитектурных компонентов на высоком уровне, а также подробности того, как их можно идентифицировать.

### Компоненты приложения

#### Веб-сервер

Простые приложения могут работать на одном сервере, который можно идентифицировать с помощью шагов, обсуждаемых в разделе [Fingerprint Web Server](02-Fingerprint_Web_Server.md) руководства.

#### Платформа как услуга (PaaS)

В модели «Платформа как услуга» (PaaS) веб-сервер и базовая инфраструктура управляются поставщиком услуг, и клиент несет ответственность только за приложение, которое развернуто на них. С точки зрения тестирования, есть два основных отличия:

- Владелец приложения не имеет доступа к базовой инфраструктуре, поэтому не сможет напрямую устранить какие-либо проблемы.
- Тестирование инфраструктуры, вероятно, будет недоступно для любых обязательств.

В некоторых случаях можно идентифицировать использование PaaS, поскольку приложение может использовать конкретное доменное имя (например, приложения, развернутые в Azure App Services, будут иметь домен `* .azurewebsites.net` - хотя они также могут использовать пользовательские домены). Однако в других случаях трудно определить, используется ли PaaS.

#### Serverless

В модели без сервера разработчики предоставляют код, который непосредственно запускается на хостинговой платформе, в качестве отдельных функций, а не в качестве традиционного более крупного веб-приложения, развернутого в webroot. Это делает его хорошо подходящим для микросервисных архитектур. Как и в случае среды PaaS, тестирование инфраструктуры, вероятно, будет недоступно.

IВ некоторых случаях использование кода без сервера может указываться наличием определенных заголовков HTTP. Например, лямбда-функции AWS обычно возвращают следующие заголовки:

```http
X-Amz-Invocation-Type
X-Amz-Log-Type
X-Amz-Client-Context
```

Функции лазур менее очевидны. Как правило, они возвращают заголовок `Server: Kestrel` - но этого само по себе недостаточно, чтобы быть уверенным, что это функция Azure App, а не какой-то другой код, работающий на Kestrel.

#### Microservices

В архитектуре на основе микросервиса API-интерфейс приложения состоит из нескольких дискретных сервисов, а не работает как монолитное приложение. Сами службы часто работают внутри контейнеров (обычно с Kubernetes) и могут использовать различные операционные системы и языки. Хотя они обычно находятся за одним шлюзом и доменом API, использование нескольких языков (часто указанных в подробных сообщениях об ошибках) может указывать на использование микросервисов.

#### Static Storage

Многие приложения хранят статический контент на выделенных платформах хранения, а не размещают его непосредственно на главном веб-сервере. Двумя наиболее распространенными платформами являются ведра Amazon S3 и учетные записи Azure, которые можно легко идентифицировать по доменным именам:

- Ведра Amazon S3 - это либо `BUCKET.s3.amazonaws.com`, либо `s3.REGION.amazonaws.com/BUCKET`
- Счета хранения Azure - это `ACCOUNT.blob.core.windows.net`

Эти учетные записи хранилища часто могут раскрывать конфиденциальные файлы, как описано в [Testing Cloud Storage Guide](../02-Configuration_and_Deployment_Management_Testing/11-Test_Cloud_Storage.md) раздел.

#### База данных

Большинство нетривиальных веб-приложений используют какую-то базу данных для хранения динамического контента. В некоторых случаях можно определить базу данных, хотя обычно она опирается на другие вопросы в приложении. Это часто можно сделать с помощью:

- Портовое сканирование сервера и поиск любых открытых портов, связанных с конкретными базами данных.
- Запуск сообщений об ошибках, связанных с SQL (или NoSQL) (или поиск существующих ошибок из a [search engine](../01-Information_Gathering/01-Conduct_Search_Engine_Discovery_Reconnaissance_for_Information_Leakage.md).

Там, где невозможно окончательно определить базу данных, вы часто можете сделать обоснованное предположение, основанное на других аспектах приложения:

- Windows, IIS and ASP.NET often use Microsoft SQL server.
- Embedded systems often use SQLite.
- PHP often uses MySQL or PostgreSQL.
- APEX often uses Oracle.

Это не жесткие правила, но, безусловно, могут дать вам разумную отправную точку, если нет лучшей информации.

#### Authentication

Большинство приложений имеют некоторую форму аутентификации для пользователей. Есть несколько задних концов аутентификации, которые можно использовать, таких как:

- Конфигурация веб-сервера (включая файлы .htaccess`) или пароли жесткого кодирования в скриптах.
    - Обычно отображается как HTTP Basic аутентификация, обозначаемая всплывающим окном в браузере и заголовком `WWW-Authenticate: Basic` HTTP.
- Локальные учетные записи пользователей в базе данных.
    - Обычно интегрируется в форму или конечную точку API в приложении.
- Существующий центральный источник аутентификации, такой как Active Directory или сервер LDAP.
    - Может использовать аутентификацию NTLM, указанную в заголовке HTTP `WWW-Authenticate: NTLM`.
    - Может быть интегрирован в веб-приложение в форме.
    - Может потребовать ввода имени пользователя в формате «DOMAIN \ username» или может привести к выпаданию доступных доменов.
- Единый вход (SSO) с внутренним или внешним поставщиком.
    - Обычно использует OAuth, OpenID Connect или SAML .

Приложения могут предоставлять пользователю несколько вариантов аутентификации (например, регистрация локальной учетной записи или использование существующей учетной записи Facebook) и могут использовать различные механизмы для обычных пользователей и администраторов.

#### Сторонние сервисы и API

Почти все веб-приложения включают сторонние ресурсы, которые загружаются или взаимодействуют клиентом. Они могут включать в себя:

- [Active content](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content#mixed_active_content) (такие как скрипты, таблицы стилей, шрифты и iframes).
- [Passive content](https://developer.mozilla.org/en-US/docs/Web/Security/Mixed_content#mixed_passivedisplay_content) (такие как изображения и видео).
- Внешние API.
- Кнопки социальных сетей.
- Рекламные сети.
- Платежные ворота.

Эти ресурсы запрашиваются непосредственно браузером пользователя, поэтому их можно легко идентифицировать с помощью инструментов разработчика или перехвата прокси. Хотя важно их идентифицировать (поскольку они могут повлиять на безопасность приложения), помните, что * они обычно не подходят для тестирования *, поскольку они принадлежат третьим сторонам.

### Сетевые компоненты

#### Reverse Proxy

Обратный прокси-сервер находится перед одним или несколькими серверными серверами и перенаправляет запросы в соответствующий пункт назначения. Они могут реализовать различные функции, такие как:

- Действуя как [load balancer](#load-balancer) или [web application firewall](#web-application-firewall-waf).
- Разрешение размещения нескольких приложений на одном IP-адресе или домене (в подпапках).
- Внедрение IP-фильтрации или другие ограничения.
- Кэширование контента с бэк-энда для повышения производительности.

Не всегда возможно обнаружить обратный прокси-сервер (особенно если за ним стоит только приложение), но вы часто можете иногда идентифицировать его по:

- Несоответствие между интерфейсом сервера и бэкэнд-приложением (например, заголовок `Server: nginx` с приложением ASP.NET).
    - Это иногда может привести к [request smuggling vulnerabilities](https://portswigger.net/web-security/request-smuggling).
- Дубликаты (особенно заголовок `Server`).
- Несколько приложений размещены на одном IP-адресе или домене (особенно если они используют разные языки).

#### Load Balancer

Балансировщик нагрузки находится перед несколькими серверными серверами и распределяет запросы между ними, чтобы обеспечить большую избыточность и емкость обработки для приложения.

Балансиров нагрузки может быть трудно обнаружить, но иногда их можно идентифицировать, делая несколько запросов и изучая ответы на различия, такие как:

- Непоследовательное системное время.
- Различные внутренние IP-адреса или имена хостов в подробных сообщениях об ошибках.
- Различные адреса возвращаются [Server-Side Request Forgery (SSRF)](../07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery.md).

Они также могут указываться наличием определенных файлов cookie (например, балансировщики нагрузки F5 BIG-IP создадут файл cookie под названием «BIGipServer»).

#### Content Delivery Network (CDN)

Сеть доставки контента (CDN) - это географически распределенный набор кэширующих прокси-серверов, предназначенный для повышения производительности веб-сайта, чтобы обеспечить дополнительную устойчивость веб-сайта.

Обычно он настраивается путем указания общедоступного домена на серверы CDN, а затем настройки CDN для подключения к правильным серверам бэк-энда (иногда называемым "origin").

Самый простой способ обнаружить CDN - выполнить поиск WHOIS для IP-адресов, которые домен разрешает. Если они принадлежат компании CDN (например, Akamai, Cloudflare или Fastly - см [Wikipedia](https://en.wikipedia.org/wiki/Content_delivery_network#Notable_content_delivery_service_providers) для более полного списка), то это похоже на то, что используется CDN.

При тестировании сайта за CDN вы должны учитывать следующие моменты:

- IP-адреса и серверы принадлежат поставщику CDN и, вероятно, не подходят для тестирования инфраструктуры.
- Многие CDN также включают такие функции, как обнаружение ботов, ограничение скорости и брандмауэры веб-приложений.
- CDN обычно кэшируют содержимое, поэтому любые изменения, внесенные в серверный сайт, могут появляться не сразу.

Если сайт находится за CDN, то может быть полезно идентифицировать серверы бэк-энда. Если у них нет надлежащего контроля доступа, вы можете обойти CDN (и любые средства защиты, которые он предлагает), напрямую войдя на серверы бэк-энда. Существует множество различных методов, которые могут позволить вам идентифицировать бэкэнд-систему:

- Письма, отправленные приложением, могут поступать напрямую с серверного сервера, который может раскрыть его IP-адрес.
- Размельчение DNS, передача зон или списки прозрачности сертификатов для домена могут раскрыть его в поддомене.
- Сканирование диапазонов IP, которые, как известно, используются компанией, может найти сервер бэк-энда.
- Использование [Server-Side Request Forgery (SSRF)](../07-Input_Validation_Testing/19-Testing_for_Server-Side_Request_Forgery.md) может раскрыть IP-адрес.
- Подробные сообщения об ошибках из приложения могут отображать IP-адреса или имена хостов.

### Компоненты безопасности

#### Сетевой брандмауэр

Большинство веб-серверов будут защищены брандмауэром фильтрации пакетов или проверки состояния, который блокирует любой сетевой трафик, который не требуется. Чтобы обнаружить это, выполните сканирование порта сервера и изучите результаты.

Если большинство портов отображаются как «закрытые» (т. Е. Они возвращают пакет «RST» в ответ на первоначальный пакет «SYN»), это говорит о том, что сервер не может быть защищен брандмауэром. Если порты отображаются как «фильтрованные» (т. Е. При отправке пакета «SYN» на неиспользуемый порт не получен ответ), то, скорее всего, будет установлен брандмауэр.

Кроме того, если неподходящие службы подвергаются воздействию мира (например, SMTP, IMAP, MySQL и т. Д.), Это говорит о том, что либо нет брандмауэра, либо брандмауэр плохо настроен.

#### Сетевая система обнаружения и предотвращения вторжений

Сетевая система обнаружения вторжений (IDS) обнаруживает подозрительную или вредоносную активность на уровне сети (например, сканирование портов или уязвимостей) и вызывает оповещения. Система предотвращения вторжений (IPS) аналогична, но также предпринимает действия для предотвращения активности - обычно путем блокировки исходного IP-адреса.

IPS обычно можно обнаружить, запустив инструменты автоматического сканирования (например, сканер портов) по цели и посмотрев, заблокирован ли исходный IP-адрес. Однако многие инструменты уровня приложения не могут быть обнаружены IPS (особенно если они не расшифровывают TLS).

#### Брандмауэр веб-приложений (WAF)

Брандмауэр веб-приложения (WAF) проверяет содержимое HTTP-запросов и блокирует те, которые кажутся подозрительными или вредоносными, или динамически применяет другие элементы управления, такие как CAPTCHA или ограничение скорости. Они обычно основаны на наборе известных плохих подписей и регулярных выражений, таких как [OWASP Core Rule Set](https://owasp.org/www-project-modsecurity-core-rule-set/).  WAF могут быть эффективными для защиты от некоторых типов атак (таких как SQL-инъекция или cross-site scripting), но менее эффективны по отношению к другим типам (таким как контроль доступа или проблемы, связанные с бизнес-логикой).

WAF может быть развернут в нескольких местах, включая:

- На самом веб-сервере.
- На отдельной виртуальной машине или аппаратном устройстве.
- В облаке перед серверным сервером.

Поскольку WAF блокирует вредоносные запросы, его можно обнаружить, добавив общие строки атаки к параметрам и наблюдая, заблокированы они или нет. Например, попробуйте добавить параметр `foo` со значением, таким как `' UNION SELECT 1` или `><script>alert(1)</script>`. Если эти запросы заблокированы, это говорит о том, что может быть WAF на месте. Кроме того, содержимое страниц блока может содержать информацию о конкретной используемой технологии. Наконец, некоторые WAF могут добавлять файлы cookie или заголовки HTTP в ответы, которые могут раскрыть их присутствие.

Если используется облачный WAF, то можно обойти его, напрямую войдя на сервер бэк-энда, используя те же методы, которые обсуждались в [Content Delivery Network](#content-delivery-network-cdn) раздел.
