# Тестирование для фиксации сеанса

| ID |
| ------------- |
| WSTG-SESS-03 |

## Резюме

Фиксация сеанса обеспечивается небезопасной практикой сохранения одного и того же значения файлов cookie сеанса до и после аутентификации. Обычно это происходит, когда сеансовые файлы cookie используются для хранения информации о состоянии даже до входа в систему, например,., добавить товары в корзину перед проверкой подлинности для оплаты.

В общем использовании уязвимостей фиксации сеанса злоумышленник может получить набор файлов cookie сеанса с целевого веб-сайта без предварительной аутентификации. Затем злоумышленник может принудительно ввести эти файлы cookie в браузер жертвы, используя различные методы. Если жертва позже аутентифицируется на целевом веб-сайте, и файлы cookie не обновляются при входе в систему, жертва будет идентифицирована с помощью файлов cookie сеанса, выбранных злоумышленником. Затем злоумышленник может выдать себя за жертву с помощью этих известных файлов cookie.

Эту проблему можно исправить, обновив сеансовые файлы cookie после процесса аутентификации. В качестве альтернативы, атака может быть предотвращена путем обеспечения целостности файлов cookie сеанса. При рассмотрении сетевых злоумышленников, т.е.злоумышленники, которые контролируют сеть, используемую жертвой, используют полностью [HSTS](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security) или добавить`__Host-` / `__Secure-` префикс к имени файла cookie.

Полное принятие HSTS происходит, когда хост активирует HSTS для себя и всех своих субдоменов. Это описано в статье под названием *Testing for Integrity Flaws in Web Sessions* Стефано Кальзавара, Альвизе Рабитти, Алессио Рагаццо и Микеле Буглиеси.

## Цели теста

- Проанализируйте механизм аутентификации и его поток.
- Принудительные куки и оцените влияние.

## Как проверить

В этом разделе мы даем объяснение стратегии тестирования, которая будет показана в следующем разделе.

Первый шаг - сделать запрос на тестируемый сайт (_e.g._ `www.example.com`). Если тестер запрашивает следующее:

```http
GET / HTTP/1.1
Host: www.example.com
```

Они получат следующий ответ:

```html
HTTP/1.1 200 OK
Date: Wed, 14 Aug 2008 08:45:11 GMT
Server: IBM_HTTP_Server
Set-Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1; Path=/; secure
Cache-Control: no-cache="set-cookie,set-cookie2"
Expires: Thu, 01 Dec 1994 16:00:00 GMT
Keep-Alive: timeout=5, max=100
Connection: Keep-Alive
Content-Type: text/html;charset=Cp1254
Content-Language: en-US
```

Приложение устанавливает новый идентификатор сеанса `JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1`, для клиента.

Затем, если тестер успешно аутентифицируется в приложении со следующим POST to `https://www.example.com/authentication.php`:

```http
POST /authentication.php HTTP/1.1
Host: www.example.com
[...]
Referer: http://www.example.com
Cookie: JSESSIONID=0000d8eyYq3L0z2fgq10m4v-rt4:-1
Content-Type: application/x-www-form-urlencoded
Content-length: 57

Name=Meucci&wpPassword=secret!&wpLoginattempt=Log+in
```

Тестер наблюдает следующий ответ от сервера:

```http
HTTP/1.1 200 OK
Date: Thu, 14 Aug 2008 14:52:58 GMT
Server: Apache/2.2.2 (Fedora)
X-Powered-By: PHP/5.1.6
Content-language: en
Cache-Control: private, must-revalidate, max-age=0
X-Content-Encoding: gzip
Content-length: 4090
Connection: close
Content-Type: text/html; charset=UTF-8
...
HTML data
...
```

Поскольку при успешной аутентификации не было выпущено ни одного нового файла cookie, тестер знает, что можно выполнить захват сеанса, если не обеспечена целостность файла cookie сеанса.

Тестер может отправить пользователю действительный идентификатор сеанса (возможно, с помощью трюка социальной инженерии), подождать, пока он аутентифицируется, и впоследствии убедиться, что привилегии были назначены этому cookie.

### Тест с принудительным печеньем

Эта стратегия тестирования предназначена для сетевых злоумышленников, поэтому ее нужно применять только к сайтам без полного принятия HSTS (сайты с полным внедрением HSTS безопасны, поскольку все их файлы cookie имеют целостность). Мы предполагаем, что на тестируемом веб-сайте есть две учетные записи тестирования: одна - жертва, а другая - злоумышленник. Мы моделируем сценарий, при котором злоумышленник выдает в браузере жертвы все файлы cookie, которые не были выпущены недавно после входа в систему и не имеют целостности. После входа жертвы злоумышленник представляет принудительные файлы cookie на веб-сайт для доступа к учетной записи жертвы: если их достаточно, чтобы действовать от имени жертвы, возможна фиксация сеанса.

Вот шаги для выполнения этого теста:

1. Перейдите на страницу входа на сайт.
2. Сохраните снимок банки с файлами cookie перед входом в систему, за исключением файлов cookie, которые содержат префикс `__Host-` или `__Secure-` в своем имени.
3. Войдите на сайт как жертва и зайдите на любую страницу, предлагающую безопасную функцию, требующую аутентификации.
4. Установите банку с печеньем на снимок, сделанный на шаге 2.
5. Запустите безопасную функцию, указанную на шаге 3.
6. Посмотрите, была ли операция на шаге 5 успешно выполнена. Если так, атака была успешной.
7. Очистите банку с файлами cookie, войдите в систему как злоумышленник и перейдите на страницу на шаге 3.
8. Напишите в банке с печеньем, один за другим, куки сохраняются на шаге 2.
9. Снова запустите безопасную функцию, указанную на шаге 3.
10. Очистите банку с печеньем и снова войдите в систему как жертва.
11. Посмотрите, была ли операция на шаге 9 успешно выполнена на счете жертвы. Если это так, атака была успешной; в противном случае сайт защищен от фиксации сеанса.

Мы рекомендуем использовать две разные машины или браузеры для жертвы и злоумышленника. Это позволяет уменьшить количество ложных срабатываний, если веб-приложение выполняет дактилоскопию для проверки доступа, включенного из данного файла cookie. Более короткий, но менее точный вариант стратегии тестирования требует только одной учетной записи тестирования. Он следует тем же шагам, но останавливается на шаге 6.

## Восстановление

Внедрить обновление токена сеанса после успешной аутентификации пользователя.

Приложение всегда должно сначала аннулировать существующий идентификатор сеанса перед аутентификацией пользователя, а если аутентификация прошла успешно, укажите другой идентификатор сеанса

## Tools

- [OWASP ZAP](https://www.zaproxy.org)

## References

- [Session Fixation](https://owasp.org/www-community/attacks/Session_fixation)
- [ACROS Security](https://www.acrossecurity.com/papers/session_fixation.pdf)
- [Chris Shiflett](http://shiflett.org/articles/session-fixation)
