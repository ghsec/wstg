# Тестирование на сеанс угона

| ID |
| ------------- |
| WSTG-SESS-09 |

## Резюме

Злоумышленник, получивший доступ к файлам cookie сеанса пользователя, может выдать себя за них, представив такие файлы cookie. Эта атака известна как захват сеанса. При рассмотрении сетевых злоумышленников, т.е.злоумышленники, которые контролируют сеть, используемую жертвой, сеансовые куки могут быть чрезмерно подвержены злоумышленнику по HTTP. Чтобы предотвратить это, сеансовые куки должны быть помечены атрибутом `Secure`, чтобы они передавались только по HTTPS .

Обратите внимание, что атрибут `Secure` также следует использовать, когда веб-приложение полностью развернуто через HTTPS, в противном случае возможна следующая атака кражи файлов cookie. Предположим, что `example.com` полностью развернут через HTTPS, но не помечает свои сеансовые куки как `Secure`. Возможны следующие шаги атаки:

1. Жертва отправляет запрос `http://another-site.com`.
2. Злоумышленник повреждает соответствующий ответ, так что он запускает запрос `http://example.com`.
3. Браузер теперь пытается получить доступ `http://example.com`.
4. Хотя запрос не выполняется, сеансовые куки просочились в чистоте по HTTP

В качестве альтернативы, захват сеанса можно предотвратить, запретив использование HTTP [HSTS](https://en.wikipedia.org/wiki/HTTP_Strict_Transport_Security). Обратите внимание, что здесь есть тонкость, связанная с покачиванием файлов cookie. В частности, полное принятие HSTS требуется, когда сеансовые файлы cookie выпускаются с набором атрибутов `Domain`.

Полное принятие HSTS описано в статье под названием *Testing for Integrity Flaws in Web Sessions* Стефано Кальзавара, Альвизе Рабитти, Алессио Рагаццо и Микеле Буглиеси. Полное принятие HSTS происходит, когда хост активирует HSTS для себя и всех своих субдоменов. Частичное принятие HSTS - это когда хост активирует HSTS только для себя.

С набором атрибутов `Domain` файлы cookie сеанса могут совместно использоваться между поддоменами. Следует избегать использования HTTP с поддоменами, чтобы предотвратить раскрытие незашифрованных файлов cookie, отправленных по HTTP. Чтобы проиллюстрировать этот недостаток безопасности, предположим, что веб-сайт `example.com` активирует HSTS без опции `includeSubDomains`. Веб-сайт выдает сеансовые файлы cookie с атрибутом `Domain`, установленным в `example.com`. Возможна следующая атака:

1. Жертва отправляет запрос `http://another-site.com`.
2. Злоумышленник повреждает соответствующий ответ, так что он запускает запрос `http://fake.example.com`.
3. Браузер теперь пытается получить доступ `http://fake.example.com`, что разрешено конфигурацией HSTS.
4. Поскольку запрос отправляется в поддомен `example.com` с набором атрибутов `Domain`, он включает в себя сеансовые файлы cookie, которые просачиваются в прозрачный HTTP

Полный HSTS должен быть активирован на апексном домене, чтобы предотвратить эту атаку.

## Цели теста

- Определите уязвимые сеансовые куки.
- Убейте уязвимые файлы cookie и оцените уровень риска.

## Как проверить

Стратегия тестирования предназначена для сетевых злоумышленников, поэтому ее нужно применять только к сайтам без полного принятия HSTS (сайты с полным внедрением HSTS безопасны, поскольку их файлы cookie не передаются по HTTP). Мы предполагаем, что на тестируемом веб-сайте есть две учетные записи тестирования: одна - жертва, а другая - злоумышленник. Мы моделируем сценарий, при котором злоумышленник крадет все файлы cookie, которые не защищены от раскрытия по HTTP, и представляет их на веб-сайт для доступа к учетной записи жертвы. Если этих файлов cookie достаточно, чтобы действовать от имени жертвы, возможен захват сеанса.

Вот шаги для выполнения этого теста:

1. Войдите на сайт как жертва и зайдите на любую страницу, предлагающую безопасную функцию, требующую аутентификации.
2. Удалить из банки с печеньем все файлы cookie, которые удовлетворяют любому из следующих условий.
    - в случае отсутствия принятия HSTS: установлен атрибут `Secure`.
    - в случае частичного принятия HSTS: установлен атрибут `Secure` или атрибут `Domain` не установлен.
3. Сохраните снимок банки с печеньем.
4. Запустите безопасную функцию, указанную на шаге 1.
5. Посмотрите, была ли операция на шаге 4 успешно выполнена. Если так, атака была успешной.
6. Очистите банку с файлами cookie, войдите в систему как злоумышленник и перейдите на страницу на шаге 1.
7. Напишите в банке с печеньем, один за другим, куки сохраняются на шаге 3.
8. Снова запустите безопасную функцию, указанную на шаге 1.
9. Очистите банку с печеньем и снова войдите в систему как жертва.
10. Посмотрите, была ли операция на шаге 8 успешно выполнена на счете жертвы. Если это так, атака была успешной; в противном случае сайт защищен от захвата сеанса.

Мы рекомендуем использовать две разные машины или браузеры для жертвы и злоумышленника. Это позволяет уменьшить количество ложных срабатываний, если веб-приложение выполняет дактилоскопию для проверки доступа, включенного из данного файла cookie. Более короткий, но менее точный вариант стратегии тестирования требует только одной учетной записи тестирования. Он следует той же схеме, но останавливается на шаге 5 (обратите внимание, что это делает шаг 3 бесполезным).

## Tools

- [OWASP ZAP](https://www.zaproxy.org)
- [JHijack - a numeric session hijacking tool](https://sourceforge.net/projects/jhijack/)
